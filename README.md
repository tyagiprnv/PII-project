# Sentinel

**Enterprise-grade PII redaction gateway with AI-powered compliance enforcement.**

Three-layer security architecture combining NLP detection, policy-based compliance (HIPAA/PCI-DSS/GDPR), and LLM verification. Production-ready with authentication, audit trails, and Kubernetes deployment.

---

## Why Sentinel?

Traditional PII redaction tools lack context awareness and compliance flexibility. Sentinel solves this with:

- **Compliance-First Design**: Pre-configured policies for HIPAA, PCI-DSS, and GDPR
- **AI Verification**: LLM auditor catches context-dependent leaks missed by pattern matching
- **Production Security**: API key authentication, immutable audit logs, policy-based restoration controls
- **Battle-Tested**: 85% test coverage across 99 tests, 43-case benchmark suite

---

## Three-Layer Security Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                      FastAPI Gateway                          │
│            (Authentication + Audit Logging)                   │
└──────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  Layer 1:       │  │  Layer 2:       │  │  Layer 3:       │
│  NLP Detection  │─▶│  Policy Engine  │─▶│  LLM Auditor    │
│  (Presidio)     │  │  (Compliance)   │  │  (Phi-3)        │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                    │                    │
         └────────────────────┴────────────────────┘
                              ▼
                     ┌─────────────────┐
                     │  Redis Storage  │
                     │  (24hr TTL)     │
                     └─────────────────┘
```

**Layer 1: Detection** - Presidio analyzes text for 13 PII entity types (EMAIL, SSN, CREDIT_CARD, etc.)
**Layer 2: Policy Engine** - Filters entities by compliance context, confidence thresholds, restoration permissions
**Layer 3: Verification** - LLM auditor validates redaction quality, purges tokens if leaks detected

---

## Quick Start

### Docker Compose (Recommended)

```bash
# Clone and start all services (API, Redis, PostgreSQL, Ollama, Prometheus, Grafana)
git clone <your-repo-url> && cd sentinel
docker-compose up --build

# Initialize database and generate admin API key
docker-compose exec api uv run python scripts/init_db.py
# Save the API key displayed - you cannot retrieve it later!
```

### Test the API

```bash
# Redact PII with healthcare policy (HIPAA-compliant)
curl -X POST http://localhost:8000/redact \
  -H "Content-Type: application/json" \
  -d '{
    "text": "Patient John Doe, DOB: 1990-05-15, SSN: 123-45-6789",
    "policy": {"context": "healthcare"}
  }'

# Response:
# {
#   "redacted_text": "Patient [REDACTED_a1b2], DOB: [REDACTED_c3d4], SSN: [REDACTED_e5f6]",
#   "confidence_scores": {"PERSON": 0.95, "DATE_TIME": 0.85, "US_SSN": 1.0},
#   "policy": {
#     "context": "healthcare",
#     "restoration_allowed": false,
#     "entities_filtered": 3
#   }
# }

# Restore original text (requires API key, fails if policy blocks restoration)
curl -X POST http://localhost:8000/restore \
  -H "X-API-Key: your_64_char_api_key" \
  -H "Content-Type: application/json" \
  -d '{"redacted_text": "Patient [REDACTED_a1b2]"}'
```

---

## Policy Engine: Compliance Made Simple

### Pre-Configured Contexts

**General Policy** - Default, broad PII coverage
- 13 entity types (EMAIL, PHONE, CREDIT_CARD, SSN, etc.)
- Restoration disabled by default (opt-in security)

**Healthcare Policy** - HIPAA-compliant PHI redaction
- 7 entity types (PERSON, DATE_TIME, US_SSN, etc.)
- Min confidence: 0.5 (reduce false positives)
- Restoration permanently disabled

**Finance Policy** - PCI-DSS-compliant financial data
- 8 entity types (CREDIT_CARD, IBAN_CODE, US_BANK_NUMBER, etc.)
- Min confidence: 0.6 (high-security threshold)
- Restoration permanently disabled

### Custom Policy Overrides

```bash
# Disable specific entities (e.g., allow dates in output)
curl -X POST http://localhost:8000/redact \
  -d '{
    "text": "Meeting on 2024-01-15 with john@example.com",
    "policy": {
      "context": "general",
      "disabled_entities": ["DATE_TIME"],
      "restoration_allowed": true
    }
  }'

# Set custom confidence threshold
curl -X POST http://localhost:8000/redact \
  -d '{
    "text": "Contact Jane at jane@example.com",
    "policy": {
      "enabled_entities": ["EMAIL_ADDRESS"],
      "min_confidence_threshold": 0.8
    }
  }'
```

---

## Authentication & Audit Trail

**Secure Restoration**: `/restore` endpoint requires API key authentication

```bash
# Create API key for service
curl -X POST http://localhost:8000/admin/api-keys \
  -d '{"service_name": "customer-portal", "description": "Restore access"}'

# List active keys (hashed, not retrievable)
curl http://localhost:8000/admin/api-keys

# Query audit logs (GDPR/HIPAA compliance)
curl http://localhost:8000/admin/audit-logs?service_name=customer-portal&limit=100

# Revoke key immediately
curl -X DELETE http://localhost:8000/admin/api-keys/{key-id}
```

**Audit Log Fields**: request_id, service_name, timestamp, redacted_text, restored_text, token_count, success, ip_address, user_agent

---

## Installation & Development

### Prerequisites
- Python 3.13+ with [uv](https://github.com/astral-sh/uv) package manager
- Docker & Docker Compose

### Local Setup

```bash
# Install uv (fast Python package manager)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install dependencies
uv pip install -r requirements.txt
uv run python -m spacy download en_core_web_lg

# Start services
docker-compose up -d

# Run the application
uvicorn app.main:app --reload
```

---

## Testing & Quality Assurance

### Test Coverage: 85% (99/99 tests passing)

```bash
# Run full test suite with coverage
uv run pytest --cov=app --cov-report=html --cov-report=term

# Quick run
uv run pytest --cov=app --cov-report=term -q

# Specific test categories
uv run pytest tests/unit/ -v           # Unit tests
uv run pytest tests/integration/ -v    # Integration tests
```

**Coverage Breakdown:**
- 100% Coverage: `audit.py`, `policies.py`, `policy_schemas.py`, `service.py`
- 93% Coverage: `verification.py`
- 91% Coverage: `database.py`
- 79% Coverage: `main.py`

### Evaluation Framework

```bash
# Run benchmark suite (43 test cases, 7 entity types)
uv run python evaluation/evaluate.py

# Baseline comparison (Presidio vs regex)
uv run python evaluation/baseline_comparison.py
```

**Metrics Tracked:** Precision, Recall, F1-Score, Latency (P50/P95/P99)

---

## LLM Prompt Engineering

Four prompt versions for systematic optimization:

| Version | Strategy | Best Use Case |
|---------|----------|---------------|
| **v1_basic** | Zero-shot instruction | Baseline/fast inference |
| **v2_cot** | Chain-of-thought reasoning | Complex edge cases |
| **v3_few_shot** | 7 curated examples | Best accuracy (+15-20%) |
| **v4_optimized** | Concise 2-example | Balanced speed/accuracy |

**Configure in `.env`:**
```bash
PROMPT_VERSION=v3_few_shot
FEW_SHOT_EXAMPLES_COUNT=3
USE_CHAIN_OF_THOUGHT=true
```

---

## Production Deployment

### Kubernetes + Helm

```bash
# Deploy with Helm
helm install sentinel k8s/helm/sentinel/ \
  --namespace pii-gateway \
  --create-namespace

# Or apply base manifests
kubectl apply -f k8s/base/

# Check deployment
kubectl get pods -l app=sentinel-api
```

**Production Features:**
- Horizontal Pod Autoscaling (HPA) for traffic spikes
- Redis StatefulSet with persistent volumes
- PostgreSQL connection pooling
- GPU-enabled nodes for Ollama
- TLS ingress with cert-manager
- Prometheus + Grafana monitoring

### CI/CD (GitHub Actions)

**`.github/workflows/claude-code-review.yml`** - Automated PR review with Claude Code
**`.github/workflows/claude.yml`** - Issue/PR comment integration (`@claude help me fix X`)

---

## Monitoring & Observability

**Prometheus Metrics** (`http://localhost:8000/metrics`):
- `total_redactions` - Request counter
- `model_confidence_scores` - Presidio confidence histogram
- `auditor_leaks_found_total` - LLM leak detection counter

**Grafana Dashboards** (`http://localhost:3000`, admin/admin):
- Request rate and latency
- Redaction success rate
- Entity detection breakdown
- LLM audit results

---

## API Endpoints

### Core Endpoints
- `POST /redact` - Redact PII with policy-based filtering
- `POST /restore` - **[AUTH]** Restore original text from tokens
- `GET /policies` - List available policy contexts
- `GET /metrics` - Prometheus metrics

### Admin Endpoints
- `POST /admin/api-keys` - Create API key
- `GET /admin/api-keys` - List API keys (hashed)
- `DELETE /admin/api-keys/{id}` - Revoke API key
- `GET /admin/audit-logs` - Query restoration audit trail

---

## Technical Stack

**Core:** FastAPI, Presidio (NLP), Phi-3 LLM (Ollama), Redis, PostgreSQL, SQLAlchemy
**Testing:** pytest (85% coverage), fakeredis, respx, aiosqlite
**Deployment:** Docker, Kubernetes, Helm
**Monitoring:** Prometheus, Grafana
**Package Management:** uv (fast Python resolver)

---

## Project Structure

```
PII-project/
├── app/                   # Core application
│   ├── main.py           # FastAPI endpoints
│   ├── service.py        # Redaction service
│   ├── policies.py       # Policy engine
│   ├── verification.py   # LLM auditor
│   ├── database.py       # SQLAlchemy models
│   ├── auth.py           # API key auth
│   └── audit.py          # Audit logging
├── tests/                # 99 tests, 85% coverage
│   ├── unit/            # Unit tests
│   └── integration/     # Integration tests
├── evaluation/           # Benchmark suite (43 cases)
├── k8s/                  # Kubernetes deployment
│   ├── base/            # Base manifests
│   └── helm/sentinel/   # Helm chart
├── .github/workflows/   # CI/CD pipelines
└── docker-compose.yml   # Local development stack
```

---

## Contributing

Contributions welcome! Ensure:
- Tests pass with >85% coverage
- Follow existing code style
- Update documentation
- Run `uv run pytest` before submitting

---

## Acknowledgments

Built with [Microsoft Presidio](https://github.com/microsoft/presidio), [Ollama](https://ollama.ai), and [FastAPI](https://fastapi.tiangolo.com)

---

**Production-ready PII redaction with compliance enforcement. Deploy with confidence.**
